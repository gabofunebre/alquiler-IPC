<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configuración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;z-index:1000;}
    .periodo0.offset0 td {background-color:#ffffff;}
    .periodo0.offset1 td {background-color:#f2f2f2;}
    .periodo1.offset0 td {background-color:#e7f5ff;}
    .periodo1.offset1 td {background-color:#d0ebff;}
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Configuración</span>
      <form class="d-flex" action="{{ url_for('app.logout') }}" method="post">
        <button class="btn btn-outline-secondary" type="submit">Salir</button>
      </form>
    </div>
  </nav>
  <div class="container pb-5">
    <div id="alert-placeholder"></div>

    <section class="mb-5">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h5 mb-0">Configuración del sistema</h2>
      </div>
      <form id="global-config-form" method="post" class="mb-3">
        <input type="hidden" name="form_type" value="global">
        <input type="hidden" name="selected_user" value="{{ selected_user or '' }}">
        <div class="mb-3">
          <label class="form-label" for="api-url-input">URL de la API del IPC</label>
          <input type="url" class="form-control" id="api-url-input" name="api_url" value="{{ api_url_configured }}" placeholder="https://...">
          <div class="form-text">Se aplica a todos los contratantes. Si queda vacío se usa la ruta oficial del INDEC.</div>
        </div>
        {% if global_config_extras %}
        {% for key, value in global_config_extras.items() %}
        <div class="mb-3">
          <label class="form-label" for="global-field-{{ loop.index }}">{{ key.replace('_', ' ')|capitalize }}</label>
          <input type="text" class="form-control" id="global-field-{{ loop.index }}" name="{{ key }}" value="{{ value }}">
        </div>
        {% endfor %}
        {% endif %}
        <button type="submit" class="btn btn-primary">Guardar ajustes del sistema</button>
      </form>
      <div class="border rounded p-3 bg-light">
        <p class="mb-1"><strong>URL en uso:</strong> <code>{{ api_url_current }}</code></p>
        <p class="mb-1"><strong>Datos descargados:</strong> {{ 'Sí' if api_cache_info.has_cache else 'No' }}</p>
        <p class="mb-0">
          <strong>Última descarga:</strong>
          {% if api_cache_info.last_cached_at_text %}
            {{ api_cache_info.last_cached_at_text }}
          {% elif api_cache_info.fetched_at_text %}
            {{ api_cache_info.fetched_at_text }}
          {% else %}
            &mdash;
          {% endif %}
        </p>
      </div>
    </section>

    <section class="mb-4">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h5 mb-0">Contratantes</h2>
        <button type="button" class="btn btn-success ms-auto" data-bs-toggle="modal" data-bs-target="#addContratanteModal">
          Nuevo contratante
        </button>
      </div>
      {% if contratantes %}
      <form id="user-select-form" class="row g-3 align-items-end mb-4" method="get">
        <div class="col-sm-6 col-md-5">
          <label class="form-label" for="selected-user">Contratante</label>
          <select class="form-select" id="selected-user" name="user">
            {% for contratante in contratantes %}
            <option value="{{ contratante.id }}" {% if contratante.id == selected_user %}selected{% endif %}>{{ contratante.display }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto d-flex flex-wrap gap-2 mt-4 mt-sm-0">
          <button type="submit" class="btn btn-secondary">Ver</button>
          <button type="button" class="btn btn-primary" id="edit-contratante-btn" data-bs-toggle="modal" data-bs-target="#editContratanteModal" {% if not selected_user %}disabled{% endif %}>Editar</button>
          <button type="button" class="btn btn-outline-danger" id="delete-contratante-btn" data-bs-toggle="modal" data-bs-target="#deleteContratanteModal" {% if not selected_user %}disabled{% endif %}>Eliminar</button>
        </div>
      </form>
      {% else %}
      <p class="text-muted mb-4">No hay contratantes cargados. Creá uno para configurar sus datos.</p>
      {% endif %}
      {% if selected_contratante %}
      {% set cfg = selected_contratante.config %}
      <div class="card mb-4">
        <div class="card-header">Datos del contratante</div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Nombre</dt>
            <dd class="col-sm-8">{{ cfg.nombre or '—' }}</dd>
            <dt class="col-sm-4">Apellido</dt>
            <dd class="col-sm-8">{{ cfg.apellido or '—' }}</dd>
            <dt class="col-sm-4">DNI</dt>
            <dd class="col-sm-8">{{ cfg.dni or '—' }}</dd>
            <dt class="col-sm-4">Dirección</dt>
            <dd class="col-sm-8">{{ cfg.direccion or '—' }}</dd>
            <dt class="col-sm-4">Teléfono</dt>
            <dd class="col-sm-8">
              {% if cfg.telefono %}
              <a href="tel:{{ cfg.telefono }}">{{ cfg.telefono }}</a>
              {% else %}
              &mdash;
              {% endif %}
            </dd>
            <dt class="col-sm-4">Mail</dt>
            <dd class="col-sm-8">
              {% if cfg.mail %}
              <a href="mailto:{{ cfg.mail }}">{{ cfg.mail }}</a>
              {% else %}
              &mdash;
              {% endif %}
            </dd>
            <dt class="col-sm-4">Inmueble locado</dt>
            <dd class="col-sm-8">{{ cfg.inmueble_locado or '—' }}</dd>
            <dt class="col-sm-4">Fecha de inicio de contrato</dt>
            <dd class="col-sm-8">{{ cfg.fecha_inicio_contrato or '—' }}</dd>
            <dt class="col-sm-4">Valor inicial contrato</dt>
            <dd class="col-sm-8">{{ cfg.valor_inicial_contrato or '—' }}</dd>
            <dt class="col-sm-4">Período de actualización (meses)</dt>
            <dd class="col-sm-8">{{ cfg.periodo_actualizacion_meses or '—' }}</dd>
          </dl>
        </div>
      </div>
      {% elif contratantes %}
      <p class="text-muted mb-4">Seleccioná un contratante para ver sus datos.</p>
      {% endif %}
    </section>

    {% if tabla_error %}
    <div class="alert alert-danger mt-3" role="alert">{{ tabla_error }}</div>
    {% endif %}
    {% if tabla %}
    <hr>
    {% set tabla_contratante = selected_contratante.label if selected_contratante else selected_user %}
    <h2 class="h5 mt-4">Tabla de alquiler para {{ tabla_contratante }}</h2>
    <div class="text-end mb-2">Fecha de hoy: {{ fecha_hoy }}</div>
    {% if ipc_status and ipc_status.last_cached_at_text %}
    <div class="text-end text-muted mb-2">Última actualización del IPC: {{ ipc_status.last_cached_at_text }}</div>
    {% endif %}
    {% if ipc_status and ipc_status.error %}
    <div class="alert alert-warning" role="alert">
      No se pudo actualizar el IPC. Se muestran los datos guardados del
      {% if ipc_status.last_cached_at_text %}{{ ipc_status.last_cached_at_text }}{% else %}archivo en caché{% endif %}.
    </div>
    {% endif %}
    <table class="table table-bordered">
      <thead>
        <tr><th>Mes</th><th>IPC</th><th>Ajuste</th><th>Valor</th></tr>
      </thead>
      <tbody>
        {% for fila in tabla %}
        <tr class="periodo{{ fila.periodo % 2 }} offset{{ fila.offset % 2 }}">
          <td>{{ fila.mes }}</td>
          <td>{% if fila.ipc is defined and fila.ipc is not none %}{{ '{:.1f}'.format(fila.ipc)|replace('.', ',') }}%{% endif %}</td>
          <td>{% if fila.ajuste is not none %}${{ '{:,.0f}'.format(fila.ajuste) }}{% endif %}</td>
          <td>{% if fila.valor is not none %}${{ '{:,.0f}'.format(fila.valor) }}{% endif %}{% if fila.provisorio is defined and fila.provisorio %} <span class="badge bg-warning text-dark">Provisorio</span>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% elif tabla_error %}
    <hr>
    <div class="alert alert-danger mt-4">Error cargando IPC.</div>
    {% elif not tiene_config %}
    <hr>
    {% if selected_user %}
    {% set mensaje_contratante = selected_contratante.label if selected_contratante else selected_user %}
    <div class="alert alert-info mt-4">No hay datos de configuración para {{ mensaje_contratante }}. Completá el formulario para generarlos.</div>
    {% else %}
    <div class="alert alert-info mt-4">No hay contratantes configurados. Agregá uno para comenzar.</div>
    {% endif %}
    {% endif %}
  </div>

  <div class="modal fade" id="addContratanteModal" tabindex="-1" aria-labelledby="addContratanteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="add-contratante-form" class="modal-content" action="{{ url_for('app.admin_add_user') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="addContratanteModalLabel">Nuevo contratante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="add-nombre">Nombre del contratante</label>
              <input type="text" class="form-control" id="add-nombre" name="nombre" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="add-apellido">Apellido</label>
              <input type="text" class="form-control" id="add-apellido" name="apellido">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="add-dni">DNI</label>
              <input type="text" class="form-control" id="add-dni" name="dni">
            </div>
            <div class="col-md-6 col-lg-8">
              <label class="form-label" for="add-direccion">Dirección</label>
              <input type="text" class="form-control" id="add-direccion" name="direccion">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="add-telefono">Teléfono</label>
              <input type="text" class="form-control" id="add-telefono" name="telefono">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="add-mail">Mail</label>
              <input type="email" class="form-control" id="add-mail" name="mail">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="add-inmueble">Inmueble locado</label>
              <input type="text" class="form-control" id="add-inmueble" name="inmueble_locado">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="add-fecha-inicio">Fecha de inicio de contrato</label>
              <input type="date" class="form-control" id="add-fecha-inicio" name="fecha_inicio_contrato">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="add-valor-inicial">Valor inicial contrato</label>
              <input type="number" step="0.01" class="form-control" id="add-valor-inicial" name="valor_inicial_contrato">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="add-periodo">Período de actualización por IPC (meses)</label>
              <select class="form-select" id="add-periodo" name="periodo_actualizacion_meses">
                {% for n in range(1, 13) %}
                <option value="{{ n }}" {% if n == 3 %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar contratante</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="editContratanteModal" tabindex="-1" aria-labelledby="editContratanteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="user-config-form" class="modal-content" action="{{ url_for('app.admin') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="editContratanteModalLabel">Editar contratante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="form_type" value="user">
          <input type="hidden" name="selected_user" value="{{ selected_user or '' }}" class="selected-user-input">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit-nombre">Nombre del contratante</label>
              <input type="text" class="form-control" id="edit-nombre" name="nombre" value="{{ user_config.nombre|default('', true) }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-apellido">Apellido</label>
              <input type="text" class="form-control" id="edit-apellido" name="apellido" value="{{ user_config.apellido|default('', true) }}">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="edit-dni">DNI</label>
              <input type="text" class="form-control" id="edit-dni" name="dni" value="{{ user_config.dni|default('', true) }}">
            </div>
            <div class="col-md-6 col-lg-8">
              <label class="form-label" for="edit-direccion">Dirección</label>
              <input type="text" class="form-control" id="edit-direccion" name="direccion" value="{{ user_config.direccion|default('', true) }}">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="edit-telefono">Teléfono</label>
              <input type="text" class="form-control" id="edit-telefono" name="telefono" value="{{ user_config.telefono|default('', true) }}">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="edit-mail">Mail</label>
              <input type="email" class="form-control" id="edit-mail" name="mail" value="{{ user_config.mail|default('', true) }}">
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="edit-inmueble">Inmueble locado</label>
              <input type="text" class="form-control" id="edit-inmueble" name="inmueble_locado" value="{{ user_config.inmueble_locado|default('', true) }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-fecha-inicio">Fecha de inicio de contrato</label>
              <input type="date" class="form-control" id="edit-fecha-inicio" name="fecha_inicio_contrato" value="{{ user_config.fecha_inicio_contrato|default('', true) }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-valor-inicial">Valor inicial contrato</label>
              <input type="number" step="0.01" class="form-control" id="edit-valor-inicial" name="valor_inicial_contrato" value="{{ user_config.valor_inicial_contrato|default('', true) }}">
            </div>
            <div class="col-md-6 col-lg-4">
              <label class="form-label" for="edit-periodo">Período de actualización por IPC (meses)</label>
              {% set periodo_sel = user_config.periodo_actualizacion_meses|default('3', true)|int %}
              <select class="form-select" id="edit-periodo" name="periodo_actualizacion_meses">
                {% for n in range(1, 13) %}
                <option value="{{ n }}" {% if periodo_sel == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" {% if not selected_user %}disabled{% endif %}>Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="deleteContratanteModal" tabindex="-1" aria-labelledby="deleteContratanteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="delete-user-form" class="modal-content" action="{{ url_for('app.admin_delete_user') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteContratanteModalLabel">Eliminar contratante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p id="delete-contratante-text" class="mb-0">¿Seguro que querés eliminar este contratante? Esta acción no se puede deshacer.</p>
          <input type="hidden" name="user" value="{{ selected_user or '' }}" class="selected-user-input">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="overlay"><div class="spinner-border text-primary" role="status"></div></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userForm = document.getElementById('user-config-form');
    const globalForm = document.getElementById('global-config-form');
    const userSelectForm = document.getElementById('user-select-form');
    const addContratanteForm = document.getElementById('add-contratante-form');
    const deleteUserForm = document.getElementById('delete-user-form');
    let skipLogoutOnUnload = false;
    const overlay = document.getElementById('overlay');
    const alertPlaceholder = document.getElementById('alert-placeholder');
    const contratantesData = {{ contratantes_data|default({}, true)|tojson }};
    const select = document.getElementById('selected-user');
    const editButton = document.getElementById('edit-contratante-btn');
    const deleteButton = document.getElementById('delete-contratante-btn');
    const selectedInputs = document.querySelectorAll('.selected-user-input');
    const editModal = document.getElementById('editContratanteModal');
    const addModal = document.getElementById('addContratanteModal');
    const deleteModal = document.getElementById('deleteContratanteModal');
    const deleteModalText = document.getElementById('delete-contratante-text');

    function showAlert(message, type) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      alertPlaceholder.append(wrapper);
    }

    function updateSelectedUser(value) {
      const current = value || '';
      selectedInputs.forEach((input) => {
        input.value = current;
      });
      if (editButton) {
        editButton.disabled = !current;
      }
      if (deleteButton) {
        deleteButton.disabled = !current;
      }
    }

    if (select) {
      updateSelectedUser(select.value);
      select.addEventListener('change', () => {
        updateSelectedUser(select.value);
      });
    } else {
      updateSelectedUser('');
    }

    function attachAjaxForm(form, options = {}) {
      if (!form) {
        return;
      }
      const { url, successMessage, errorMessage, onSuccess } = options;
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        overlay.style.display = 'flex';
        fetch(url || form.getAttribute('action') || '{{ url_for("app.admin") }}', {
          method: form.getAttribute('method') || 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then((response) => {
          if (!response.ok) {
            throw new Error();
          }
          return response.json();
        }).then((data) => {
          overlay.style.display = 'none';
          if (successMessage) {
            showAlert(successMessage, 'success');
          }
          skipLogoutOnUnload = true;
          if (onSuccess) {
            onSuccess(data, form);
          } else {
            setTimeout(() => window.location.reload(), 500);
          }
        }).catch(() => {
          overlay.style.display = 'none';
          if (errorMessage) {
            showAlert(errorMessage, 'danger');
          }
        });
      });
    }

    attachAjaxForm(userForm, {
      url: '{{ url_for("app.admin") }}',
      successMessage: 'Datos del contratante guardados correctamente',
      errorMessage: 'Error al guardar los datos del contratante',
      onSuccess: () => {
        if (editModal) {
          const modalInstance = bootstrap.Modal.getInstance(editModal);
          if (modalInstance) {
            modalInstance.hide();
          }
        }
        overlay.style.display = 'flex';
        const currentId = select ? select.value : '';
        setTimeout(() => {
          const url = new URL(window.location.href);
          if (currentId) {
            url.searchParams.set('user', currentId);
          }
          window.location.href = url.toString();
        }, 300);
      }
    });

    attachAjaxForm(globalForm, {
      url: '{{ url_for("app.admin") }}',
      successMessage: 'Ajustes del sistema guardados correctamente',
      errorMessage: 'Error al guardar los ajustes del sistema'
    });

    attachAjaxForm(addContratanteForm, {
      url: '{{ url_for("app.admin_add_user") }}',
      successMessage: 'Contratante creado correctamente',
      errorMessage: 'Error al crear el contratante',
      onSuccess: (data) => {
        if (addModal) {
          const modalInstance = bootstrap.Modal.getInstance(addModal);
          if (modalInstance) {
            modalInstance.hide();
          }
        }
        overlay.style.display = 'flex';
        const targetUser = data && data.user ? data.user : '';
        setTimeout(() => {
          const url = new URL(window.location.href);
          if (targetUser) {
            url.searchParams.set('user', targetUser);
          }
          window.location.href = url.toString();
        }, 300);
      }
    });

    if (userSelectForm) {
      userSelectForm.addEventListener('submit', () => {
        skipLogoutOnUnload = true;
      });
    }

    if (deleteUserForm) {
      deleteUserForm.addEventListener('submit', () => {
        skipLogoutOnUnload = true;
        overlay.style.display = 'flex';
      });
    }

    if (addModal && addContratanteForm) {
      addModal.addEventListener('show.bs.modal', () => {
        addContratanteForm.reset();
        const periodoField = addContratanteForm.querySelector('[name="periodo_actualizacion_meses"]');
        if (periodoField) {
          periodoField.value = '3';
        }
      });
    }

    if (editModal && userForm) {
      editModal.addEventListener('show.bs.modal', () => {
        const currentId = select ? select.value : '';
        const data = contratantesData[currentId] || {};
        const config = data.config || {};
        const fields = ['nombre', 'apellido', 'dni', 'direccion', 'telefono', 'mail', 'fecha_inicio_contrato', 'valor_inicial_contrato', 'inmueble_locado'];
        fields.forEach((field) => {
          const input = userForm.querySelector(`[name="${field}"]`);
          if (input) {
            input.value = config[field] || '';
          }
        });
        const periodoField = userForm.querySelector('[name="periodo_actualizacion_meses"]');
        if (periodoField) {
          periodoField.value = config.periodo_actualizacion_meses || '3';
          if (!periodoField.value) {
            periodoField.value = '3';
          }
        }
        const selectedInput = userForm.querySelector('[name="selected_user"]');
        if (selectedInput) {
          selectedInput.value = currentId || '';
        }
      });
    }

    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', () => {
        const currentId = select ? select.value : '';
        const data = contratantesData[currentId] || {};
        if (deleteModalText) {
          const label = data.label || currentId;
          deleteModalText.textContent = label
            ? `¿Seguro que querés eliminar a ${label}? Esta acción no se puede deshacer.`
            : '¿Seguro que querés eliminar este contratante? Esta acción no se puede deshacer.';
        }
      });
    }

    window.addEventListener('beforeunload', () => {
      if (!skipLogoutOnUnload && navigator.sendBeacon) {
        navigator.sendBeacon('{{ url_for('app.logout') }}', '');
      }
    });
  </script>
</body>
</html>
