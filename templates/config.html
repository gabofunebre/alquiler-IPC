<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configuración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;z-index:1000;}
    .periodo0.offset0 td {background-color:#ffffff;}
    .periodo0.offset1 td {background-color:#f2f2f2;}
    .periodo1.offset0 td {background-color:#e7f5ff;}
    .periodo1.offset1 td {background-color:#d0ebff;}
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Configuración</span>
      <form class="d-flex" action="{{ url_for('app.logout') }}" method="post">
        <button class="btn btn-outline-secondary" type="submit">Salir</button>
      </form>
    </div>
  </nav>
  <div class="container pb-5">
    <div id="alert-placeholder"></div>

    <section class="mb-5">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h5 mb-0">Configuración del sistema</h2>
      </div>
      <form id="global-config-form" method="post" class="mb-3">
        <input type="hidden" name="form_type" value="global">
        <input type="hidden" name="selected_user" value="{{ selected_user or '' }}">
        <div class="mb-3">
          <label class="form-label" for="csv-url-input">URL de la API del IPC</label>
          <input type="url" class="form-control" id="csv-url-input" name="csv_url" value="{{ csv_url_configured }}" placeholder="https://...">
          <div class="form-text">Se aplica a todos los contratantes. Si queda vacío se usa la ruta oficial del INDEC.</div>
        </div>
        {% if global_config_extras %}
        {% for key, value in global_config_extras.items() %}
        <div class="mb-3">
          <label class="form-label" for="global-field-{{ loop.index }}">{{ key.replace('_', ' ')|capitalize }}</label>
          <input type="text" class="form-control" id="global-field-{{ loop.index }}" name="{{ key }}" value="{{ value }}">
        </div>
        {% endfor %}
        {% endif %}
        <button type="submit" class="btn btn-primary">Guardar ajustes del sistema</button>
      </form>
      <div class="border rounded p-3 bg-light">
        <p class="mb-1"><strong>URL en uso:</strong> <code>{{ csv_url_current }}</code></p>
        <p class="mb-1"><strong>Datos descargados:</strong> {{ 'Sí' if csv_cache_info.has_cache else 'No' }}</p>
        <p class="mb-0">
          <strong>Última descarga:</strong>
          {% if csv_cache_info.last_cached_at_text %}
            {{ csv_cache_info.last_cached_at_text }}
          {% elif csv_cache_info.fetched_at_text %}
            {{ csv_cache_info.fetched_at_text }}
          {% else %}
            &mdash;
          {% endif %}
        </p>
      </div>
    </section>

    <section class="mb-4">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h5 mb-0">Contratantes</h2>
        <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#addContratanteModal">
          Agregar contratante
        </button>
      </div>
      {% if contratantes %}
      <form id="user-select-form" class="row g-3 align-items-end mb-3" method="get">
        <div class="col-sm-6 col-md-4">
          <label class="form-label" for="selected-user">Contratante</label>
          <select class="form-select" id="selected-user" name="user">
            {% for u in contratantes %}
            <option value="{{ u }}" {% if u == selected_user %}selected{% endif %}>{{ u }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-secondary">Ver</button>
        </div>
      </form>
      <form id="delete-user-form" class="mb-4 d-flex" action="{{ url_for('app.admin_delete_user') }}" method="post">
        <input type="hidden" name="user" value="{{ selected_user or '' }}">
        <button class="btn btn-outline-danger ms-auto" type="submit" {% if not selected_user %}disabled{% endif %}>Eliminar contratante</button>
      </form>
      {% if selected_user %}
      <p class="text-muted">Editando configuración de <strong>{{ selected_user }}</strong>.</p>
      {% endif %}
      <form id="user-config-form" method="post" class="mb-4">
        <input type="hidden" name="form_type" value="user">
        <input type="hidden" name="selected_user" value="{{ selected_user or '' }}">
        <div class="mb-3">
          <label class="form-label">Alquiler base</label>
          <input type="number" step="0.01" class="form-control" name="alquiler_base" value="{{ user_config.alquiler_base }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Fecha de inicio de contrato</label>
          <input type="date" class="form-control" name="fecha_inicio_contrato" value="{{ user_config.fecha_inicio_contrato }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Período de actualización por IPC (meses)</label>
          {% set periodo_sel = user_config.periodo_actualizacion_meses|default(3, true)|int %}
          <select class="form-select" name="periodo_actualizacion_meses">
            {% for n in range(1, 13) %}
            <option value="{{ n }}" {% if periodo_sel == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary" {% if not selected_user %}disabled{% endif %}>Guardar contratante</button>
      </form>
      {% else %}
      <p class="text-muted mb-4">No hay contratantes cargados. Creá uno para configurar sus datos.</p>
      {% endif %}
    </section>

    {% if tabla_error %}
    <div class="alert alert-danger mt-3" role="alert">{{ tabla_error }}</div>
    {% endif %}
    {% if tabla %}
    <hr>
    <h2 class="h5 mt-4">Tabla de alquiler para {{ selected_user }}</h2>
    <div class="text-end mb-2">Fecha de hoy: {{ fecha_hoy }}</div>
    {% if ipc_status and ipc_status.last_cached_at_text %}
    <div class="text-end text-muted mb-2">Última actualización del IPC: {{ ipc_status.last_cached_at_text }}</div>
    {% endif %}
    {% if ipc_status and ipc_status.error %}
    <div class="alert alert-warning" role="alert">
      No se pudo actualizar el IPC. Se muestran los datos guardados del
      {% if ipc_status.last_cached_at_text %}{{ ipc_status.last_cached_at_text }}{% else %}archivo en caché{% endif %}.
    </div>
    {% endif %}
    <table class="table table-bordered">
      <thead>
        <tr><th>Mes</th><th>IPC</th><th>Ajuste</th><th>Valor</th></tr>
      </thead>
      <tbody>
        {% for fila in tabla %}
        <tr class="periodo{{ fila.periodo % 2 }} offset{{ fila.offset % 2 }}">
          <td>{{ fila.mes }}</td>
          <td>{% if fila.ipc is defined and fila.ipc is not none %}{{ '{:.1f}'.format(fila.ipc)|replace('.', ',') }}%{% endif %}</td>
          <td>{% if fila.ajuste is not none %}${{ '{:,.0f}'.format(fila.ajuste) }}{% endif %}</td>
          <td>{% if fila.valor is not none %}${{ '{:,.0f}'.format(fila.valor) }}{% endif %}{% if fila.provisorio is defined and fila.provisorio %} <span class="badge bg-warning text-dark">Provisorio</span>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% elif tabla_error %}
    <hr>
    <div class="alert alert-danger mt-4">Error cargando IPC.</div>
    {% elif not tiene_config %}
    <hr>
    {% if selected_user %}
    <div class="alert alert-info mt-4">No hay datos de configuración para {{ selected_user }}. Completá el formulario para generarlos.</div>
    {% else %}
    <div class="alert alert-info mt-4">No hay contratantes configurados. Agregá uno para comenzar.</div>
    {% endif %}
    {% endif %}
  </div>

  <div class="modal fade" id="addContratanteModal" tabindex="-1" aria-labelledby="addContratanteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="add-contratante-form" class="modal-content" action="{{ url_for('app.admin_add_user') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="addContratanteModalLabel">Nuevo contratante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="new-user-name">Nombre del contratante</label>
            <input type="text" class="form-control" id="new-user-name" name="new_user" required>
          </div>
          <div class="mb-3">
            <label class="form-label" for="new-user-base">Alquiler base</label>
            <input type="number" step="0.01" class="form-control" id="new-user-base" name="alquiler_base">
          </div>
          <div class="mb-3">
            <label class="form-label" for="new-user-fecha">Fecha de inicio de contrato</label>
            <input type="date" class="form-control" id="new-user-fecha" name="fecha_inicio_contrato">
          </div>
          <div class="mb-0">
            <label class="form-label" for="new-user-periodo">Período de actualización por IPC (meses)</label>
            <select class="form-select" id="new-user-periodo" name="periodo_actualizacion_meses">
              {% for n in range(1, 13) %}
              <option value="{{ n }}" {% if n == 3 %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar contratante</button>
        </div>
      </form>
    </div>
  </div>

  <div id="overlay"><div class="spinner-border text-primary" role="status"></div></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userForm = document.getElementById('user-config-form');
    const globalForm = document.getElementById('global-config-form');
    const userSelectForm = document.getElementById('user-select-form');
    const addContratanteForm = document.getElementById('add-contratante-form');
    const deleteUserForm = document.getElementById('delete-user-form');
    let skipLogoutOnUnload = false;
    const overlay = document.getElementById('overlay');
    const alertPlaceholder = document.getElementById('alert-placeholder');

    function showAlert(message, type) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      alertPlaceholder.append(wrapper);
    }

    if (addContratanteForm) {
      addContratanteForm.addEventListener('submit', () => {
        skipLogoutOnUnload = true;
      });
    }

    if (deleteUserForm) {
      deleteUserForm.addEventListener('submit', () => {
        skipLogoutOnUnload = true;
      });
    }

    if (userSelectForm) {
      const select = userSelectForm.querySelector('select');
      if (select) {
        select.addEventListener('change', () => {
          userSelectForm.submit();
        });
      }
    }

    function attachAjaxForm(form, successMessage, errorMessage) {
      if (!form) {
        return;
      }
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        overlay.style.display = 'flex';
        fetch('{{ url_for("app.admin") }}', {
          method: 'POST',
          body: new FormData(form),
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        }).then(r => {
          if (!r.ok) throw new Error();
          return r.json();
        }).then(() => {
          overlay.style.display = 'none';
          showAlert(successMessage, 'success');
          skipLogoutOnUnload = true;
          setTimeout(() => window.location.reload(), 500);
        }).catch(() => {
          overlay.style.display = 'none';
          showAlert(errorMessage, 'danger');
        });
      });
    }

    attachAjaxForm(userForm, 'Configuración del contratante guardada correctamente', 'Error al guardar la configuración del contratante');
    attachAjaxForm(globalForm, 'Ajustes del sistema guardados correctamente', 'Error al guardar los ajustes del sistema');

    window.addEventListener('beforeunload', () => {
      if (!skipLogoutOnUnload && navigator.sendBeacon) {
        navigator.sendBeacon('{{ url_for('app.logout') }}', '');
      }
    });
  </script>
</body>
</html>
